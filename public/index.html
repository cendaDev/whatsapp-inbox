<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>WhatsApp Inbox – CENDA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="app">
    <div class="sidebar">
        <div class="header">Conversaciones</div>
        <div id="chats"></div>
    </div>
    <div class="content">
        <div class="header" id="title">Selecciona un chat</div>
        <div class="messages" id="messages"><div class="empty">No hay chat seleccionado</div></div>
        <div class="composer">
            <input id="to" type="text" placeholder="Teléfono E.164 (ej. 573001112233)" />
            <input id="text" type="text" placeholder="Escribe un mensaje…" />
            <button id="send">Enviar</button>
        </div>
    </div>
</div>

<script>
    let data = [];
    let selectedPhone = null;

    const elChats = document.getElementById("chats");
    const elMsgs  = document.getElementById("messages");
    const elTitle = document.getElementById("title");
    const elTo    = document.getElementById("to");
    const elText  = document.getElementById("text");
    const elSend  = document.getElementById("send");

    function fmt(ts){
        const d = new Date((ts||0)*1000);
        return isNaN(d) ? "" : d.toLocaleString();
    }

    function renderChats() {
        // Limpia la lista solo una vez antes de volver a dibujarla
        elChats.innerHTML = "";

        data.forEach(conv => {
            const div = document.createElement("div");
            div.className = "chat";
            if (conv.phone === selectedPhone) {
                div.classList.add("selected"); // resalta el chat activo
            }

            div.onclick = () => {
                selectedPhone = conv.phone;
                elTo.value = conv.phone;

                // Resalta el seleccionado
                document.querySelectorAll(".chat").forEach(c => c.classList.remove("selected"));
                div.classList.add("selected");

                renderMessages();
            };

            div.innerHTML = `
      <div class="phone">${conv.name ? conv.name + " · " : ""}${conv.phone}</div>
      <div class="when">${fmt(conv.last_ts)}</div>
    `;
            elChats.appendChild(div);
        });
    }

    function renderMessages(){
        const conv = data.find(c => c.phone === selectedPhone);
        if(!conv){
            elTitle.textContent = "Selecciona un chat";
            elMsgs.innerHTML = `<div class="empty">No hay chat seleccionado</div>`;
            return;
        }
        elTitle.textContent = `${conv.name ? conv.name+" · " : ""}${conv.phone}`;
        elMsgs.innerHTML = "";
        conv.messages.forEach(m=>{
            const b = document.createElement("div");
            b.className = "bubble " + (m.direction === "out" ? "out" : "in");
            const status = m.direction === "out" ? ` · ${m.status||"sent"}` : "";
            b.innerHTML = `
          <div>${(m.text||"").replace(/</g,"&lt;")}</div>
          <div class="meta">${fmt(m.ts)}${status}</div>
        `;
            elMsgs.appendChild(b);
            elMsgs.scrollTop = elMsgs.scrollHeight;
        });
    }

    async function load() {
        try {
            // Siempre traer TODAS las conversaciones
            const res = await fetch("/api/messages");
            data = await res.json();

            renderChats();
            renderMessages();
        } catch (err) {
            console.error("Error al cargar mensajes:", err);
        }
    }


    elSend.onclick = async ()=>{
        const to = (elTo.value||"").trim();
        const text = (elText.value||"").trim();
        if(!to || !text) return alert("Completa teléfono y mensaje");
        const r = await fetch("/api/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ to, text })
        });
        const j = await r.json();
        if(!r.ok){
            console.error(j);
            return alert("Error al enviar: " + (j?.details?.error?.message || j.error));
        }
        elText.value = "";
        selectedPhone = to;
        await load();
    };

    // Primer carga + refresco cada 4s
    load();
    setInterval(load, 4000);
</script>
</body>
</html>
