<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>WhatsApp Inbox – CENDA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
        .app{display:grid;grid-template-columns:320px 1fr;height:100vh}
        .sidebar{border-right:1px solid #e5e7eb;overflow:auto}
        .header{padding:12px 14px;border-bottom:1px solid #e5e7eb;font-weight:600}
        .chat{padding:10px 14px;border-bottom:1px solid #f3f4f6;cursor:pointer}
        .chat:hover{background:#f9fafb}
        .chat .phone{font-weight:600}
        .chat .when{color:#6b7280;font-size:12px}
        .content{display:flex;flex-direction:column;height:100%}
        .messages{flex:1;overflow:auto;padding:16px;background:#f8fafc}
        .bubble{max-width:70%;margin:6px 0;padding:10px 12px;border-radius:14px;background:white;box-shadow:0 1px 1px rgba(0,0,0,.04)}
        .out{margin-left:auto;background:#dcfce7}
        .meta{font-size:11px;color:#6b7280;margin-top:4px}
        .composer{display:flex;gap:8px;padding:10px;border-top:1px solid #e5e7eb;background:#fff}
        input,button{font-size:16px}
        input[type=text]{flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:8px}
        button{padding:10px 14px;border:1px solid #10b981;background:#10b981;color:#fff;border-radius:8px;cursor:pointer}
        button:hover{background:#0ea47a;border-color:#0ea47a}
        .empty{margin:auto;color:#9ca3af}
    </style>
</head>
<body>
<div class="app">
    <div class="sidebar">
        <div class="header">Conversaciones</div>
        <div id="chats"></div>
    </div>
    <div class="content">
        <div class="header" id="title">Selecciona un chat</div>
        <div class="messages" id="messages"><div class="empty">No hay chat seleccionado</div></div>
        <div class="composer">
            <input id="to" type="text" placeholder="Teléfono E.164 (ej. 573001112233)" />
            <input id="text" type="text" placeholder="Escribe un mensaje…" />
            <button id="send">Enviar</button>
        </div>
    </div>
</div>

<script>
    let data = [];
    let selectedPhone = null;

    const elChats = document.getElementById("chats");
    const elMsgs  = document.getElementById("messages");
    const elTitle = document.getElementById("title");
    const elTo    = document.getElementById("to");
    const elText  = document.getElementById("text");
    const elSend  = document.getElementById("send");

    function fmt(ts){
        const d = new Date((ts||0)*1000);
        return isNaN(d) ? "" : d.toLocaleString();
    }

    function renderChats(){
        elChats.innerHTML = "";
        data.forEach(conv=>{
            const div = document.createElement("div");
            div.className = "chat";
            div.onclick = ()=>{
                selectedPhone = conv.phone;
                elTo.value = conv.phone;
                renderMessages();
            };
            div.innerHTML = `
          <div class="phone">${conv.name ? conv.name + " · " : ""}${conv.phone}</div>
          <div class="when">${fmt(conv.last_ts)}</div>
        `;
            elChats.appendChild(div);
        });
    }

    function renderMessages(){
        const conv = data.find(c => c.phone === selectedPhone);
        if(!conv){
            elTitle.textContent = "Selecciona un chat";
            elMsgs.innerHTML = `<div class="empty">No hay chat seleccionado</div>`;
            return;
        }
        elTitle.textContent = `${conv.name ? conv.name+" · " : ""}${conv.phone}`;
        elMsgs.innerHTML = "";
        conv.messages.forEach(m=>{
            const b = document.createElement("div");
            b.className = "bubble " + (m.direction === "out" ? "out" : "in");
            const status = m.direction === "out" ? ` · ${m.status||"sent"}` : "";
            b.innerHTML = `
          <div>${(m.text||"").replace(/</g,"&lt;")}</div>
          <div class="meta">${fmt(m.ts)}${status}</div>
        `;
            elMsgs.appendChild(b);
            elMsgs.scrollTop = elMsgs.scrollHeight;
        });
    }

    async function load(){
        const res = await fetch(selectedPhone ? `/api/messages?phone=${encodeURIComponent(selectedPhone)}` : "/api/messages");
        data = await res.json();
        renderChats();
        if(selectedPhone && !data.find(c => c.phone === selectedPhone)){
            // si se filtró, data es [conv]; si no, busca en data general
            const filtered = data.length===1 && data[0].phone===selectedPhone;
            if(!filtered){
                // recargar solo el seleccionado
                const r = await fetch(`/api/messages?phone=${encodeURIComponent(selectedPhone)}`);
                const single = await r.json();
                if(single.length) {
                    const conv = single[0];
                    const idx = data.findIndex(c=>c.phone===conv.phone);
                    if(idx>=0) data[idx]=conv; else data.push(conv);
                }
            }
        }
        renderMessages();
    }

    elSend.onclick = async ()=>{
        const to = (elTo.value||"").trim();
        const text = (elText.value||"").trim();
        if(!to || !text) return alert("Completa teléfono y mensaje");
        const r = await fetch("/api/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ to, text })
        });
        const j = await r.json();
        if(!r.ok){
            console.error(j);
            return alert("Error al enviar: " + (j?.details?.error?.message || j.error));
        }
        elText.value = "";
        selectedPhone = to;
        await load();
    };

    // Primer carga + refresco cada 4s
    load();
    setInterval(load, 4000);
</script>
</body>
</html>
